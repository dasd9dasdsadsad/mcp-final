name: Test Single Worker

on:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'Runtime in minutes'
        required: false
        default: '10'
      api_url:
        description: 'API server URL'
        required: false
        default: 'http://165.232.134.47:4001'
      nats_host:
        description: 'NATS server host'
        required: false
        default: '165.232.134.47'
      manager_id:
        description: 'Manager ID that spawned this worker'
        required: false
        default: 'unassigned'
      worker_id:
        description: 'Worker ID (auto-generated if not provided)'
        required: false
        default: ''

env:
  MANAGER_HOST: 165.232.134.47
  NATS_PORT: 4222
  REDIS_HOST: 165.232.134.47
  REDIS_PORT: 6379
  POSTGRES_HOST: 165.232.134.47
  POSTGRES_PORT: 5432
  POSTGRES_DB: mcp_manager
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DOCKER_IMAGE: test123434sdd/mcp-remote-worker:rest

jobs:
  spawn-single-worker:
    runs-on: ubuntu-latest
    timeout-minutes: 1440  # 24 hours for indefinite running
    
    steps:
      - name: ğŸ” Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Docker Hub Login
        run: |
          echo "Logging in to Docker Hub..."
          echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u test123434sdd --password-stdin

      - name: ğŸ“¥ Pull Docker Image
        run: |
          echo "Pulling Docker image..."
          docker pull ${{ env.DOCKER_IMAGE }}

      - name: ğŸš€ Spawn Single Worker
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ Spawning 1 Test Worker (with API connection info)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Use provided worker_id or generate one
          if [ -n "${{ github.event.inputs.worker_id }}" ]; then
            WORKER_ID="${{ github.event.inputs.worker_id }}"
            echo "âœ… Using provided Worker ID: $WORKER_ID"
          else
            WORKER_ID="github-worker-${{ github.run_id }}-test-1"
            echo "ğŸ†” Generated Worker ID: $WORKER_ID"
          fi
          
          WORKER_NAME="test-worker-${{ github.run_id }}"
          
          # Use provided API URL or default
          API_URL="${{ github.event.inputs.api_url }}"
          if [ -z "$API_URL" ]; then
            API_URL="${{ env.API_URL }}"
          fi
          
          # Use provided NATS host or default
          NATS_HOST="${{ github.event.inputs.nats_host }}"
          if [ -z "$NATS_HOST" ]; then
            NATS_HOST="${{ env.NATS_HOST }}"
          fi
          
          # Manager ID (if spawned by manager)
          MANAGER_ID="${{ github.event.inputs.manager_id }}"
          if [ -z "$MANAGER_ID" ]; then
            MANAGER_ID="unassigned"
          fi
          
          echo ""
          echo "ğŸ“‹ Configuration:"
          echo "   Worker ID: $WORKER_ID"
          echo "   API URL: $API_URL"
          echo "   NATS Host: $NATS_HOST"
          echo "   Manager ID: $MANAGER_ID"
          echo ""
          
          docker run -d \
            --name $WORKER_NAME \
            -e WORKER_ID="$WORKER_ID" \
            -e WORKER_TAGS="github,test,single-worker,rest-only" \
            -e API_URL="$API_URL" \
            -e NATS_HOST="$NATS_HOST" \
            -e MANAGER_ID="$MANAGER_ID" \
            -e MANAGER_HOST="${{ env.MANAGER_HOST }}" \
            -e POSTGRES_HOST="${{ env.POSTGRES_HOST }}" \
            -e POSTGRES_PORT="${{ env.POSTGRES_PORT }}" \
            -e POSTGRES_DB="${{ env.POSTGRES_DB }}" \
            -e POSTGRES_USER="${{ env.POSTGRES_USER }}" \
            -e POSTGRES_PASSWORD="${{ env.POSTGRES_PASSWORD }}" \
            ${{ env.DOCKER_IMAGE }}
          
          echo "âœ… Worker spawned with connection info"
          echo ""
          
          # Show running containers
          docker ps --format "table {{.Names}}\t{{.Status}}"

      - name: ğŸ”´ Keep Worker Running (Indefinitely)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”´ Worker Running INDEFINITELY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          RUNTIME_SECONDS=$(( ${{ github.event.inputs.runtime_minutes }} * 60 ))
          END_TIME=$(($(date +%s) + RUNTIME_SECONDS))
          
          # Get worker ID
          if [ -n "${{ github.event.inputs.worker_id }}" ]; then
            WORKER_ID="${{ github.event.inputs.worker_id }}"
          else
            WORKER_ID="github-worker-${{ github.run_id }}-test-1"
          fi
          
          echo "â±ï¸  Configured Runtime: ${{ github.event.inputs.runtime_minutes }} minutes"
          echo "ğŸ”— API: ${{ github.event.inputs.api_url }}"
          echo "ğŸ‘· Worker ID: $WORKER_ID"
          echo "â™¾ï¸  Mode: CONTINUOUS (will restart tasks automatically)"
          echo ""
          
          # Run indefinitely - keep checking and logging
          ITERATION=0
          while true; do
            ITERATION=$((ITERATION + 1))
            RUNNING=$(docker ps -q -f name="test-worker-${{ github.run_id }}" | wc -l)
            
            echo "[$(date '+%H:%M:%S')] Iteration $ITERATION - Worker status: $RUNNING/1 running"
            
            # Show worker logs
            docker logs test-worker-${{ github.run_id }} --tail 3 2>&1 | grep -E "âœ…|ğŸ“¨|ğŸš€|TASK|Registered|Connected" || echo "  (worker active...)"
            
            # Check if we've passed the initial runtime (but don't exit)
            CURRENT_TIME=$(date +%s)
            if [ $CURRENT_TIME -gt $END_TIME ]; then
              echo "  âš¡ Initial runtime complete - continuing indefinitely..."
            fi
            
            # Restart worker if it dies
            if [ "$RUNNING" -eq "0" ]; then
              echo "  âš ï¸  Worker stopped, restarting..."
              docker start test-worker-${{ github.run_id }} || true
            fi
            
            sleep 60  # Check every minute
          done

      - name: ğŸ›‘ Cleanup
        if: always()
        run: |
          echo "ğŸ›‘ Stopping worker..."
          docker ps -q -f name="test-worker-${{ github.run_id }}" | xargs -r docker stop
          docker ps -aq -f name="test-worker-${{ github.run_id }}" | xargs -r docker rm
          echo "âœ… Cleanup complete"

